<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Deutsch Worttrainer — SRS</title>
<style>
  :root{
    --bg:#0f1220;--card:#171a2b;--ink:#e8ebff;--muted:#aab2d5;
    --accent:#6ea8fe;--ok:#3ddc84;--bad:#ff6b6b;--yellow:#ffd166;
    --border:#242944;--hover:#1b1f34
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);color:var(--ink);
  }

  /* Header */
  header{position:sticky;top:0;z-index:10;
    background:linear-gradient(180deg,#0f1220,rgba(15,18,32,.85));
    backdrop-filter:blur(6px);border-bottom:1px solid #12162a}
  .wrap{max-width:1040px;margin:0 auto;padding:14px 16px}
  h1{font-size:20px;margin:0 0 6px}
  .goal{display:flex;align-items:center;gap:10px}
  .bar{flex:1;height:10px;background:#222744;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--ok),#52d1ff);width:0%}
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0 0}
  .tabbtn{appearance:none;border:1px solid #2a2f4a;background:#14172a;color:var(--ink);
    padding:8px 10px;border-radius:12px;cursor:pointer;display:flex;gap:6px;align-items:center}
  .tabbtn:hover{background:var(--hover)}
  .tabbtn.active{background:var(--accent);border-color:var(--accent);color:#0a0d1a}

  main{padding:16px}
  section{display:none}
  section.active{display:block}

  /* Cards */
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  .grid{display:grid;gap:12px}
  @media(min-width:760px){.grid.cols-2{grid-template-columns:1fr 1fr}}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* Inputs */
  input,textarea,select{
    width:100%;padding:12px;border-radius:12px;border:1px solid #2a2f4a;background:#0e1120;color:var(--ink)
  }
  textarea{min-height:140px}
  label{display:block;font-size:14px;color:var(--muted);margin:4px 0 8px}

  /* Buttons */
  .btn{appearance:none;border:1px solid #2a2f4a;background:#14172a;color:var(--ink);
    padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn:hover{background:var(--hover)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#0b0f1c}
  .btn.good{background:var(--ok);border-color:var(--ok);color:#08140d}
  .btn.bad{background:var(--bad);border-color:var(--bad)}
  .btn.ghost{background:transparent}
  .pill{padding:6px 10px;border-radius:999px;background:#14172a;border:1px solid #2a2f4a;color:var(--muted);font-size:12px}

  .hint{color:var(--muted);font-size:13px}
  .muted{color:var(--muted)}
  .right{text-align:right}

  .fc-word{font-size:34px;text-align:center;margin:18px 0}
  .fc-translation{font-size:22px;text-align:center;color:var(--yellow)}
  .big-actions{display:flex;gap:10px}
  .big-actions .btn{flex:1;padding:14px 16px;font-size:18px}

  .kbd{display:inline-block;border:1px solid #2a2f4a;border-bottom-width:3px;border-radius:8px;padding:6px 10px;margin-right:6px;background:#12152a}

  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #232847;padding:8px;text-align:left}
  th{color:var(--muted);font-weight:600}

  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#101327;border:1px solid #2a2f4a;margin:2px 6px 2px 0}
  .drag{cursor:grab}
  .drag:active{cursor:grabbing}
  .star{cursor:pointer;user-select:none}
  .star.active{color:#ffd166}

  /* Icons */
  .ico{width:16px;height:16px;display:inline-block;vertical-align:-2px}
  .ico svg{width:16px;height:16px;fill:currentColor}

  /* Toast */
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111528;border:1px solid #2a2f4a;color:var(--ink);
    padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:opacity .25s}

  /* Toggle */
  .switch{position:relative;display:inline-block;width:48px;height:26px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#2a2f4a;transition:.2s;border-radius:999px}
  .slider:before{position:absolute;content:"";height:20px;width:20px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s}
  .switch input:checked + .slider{background:var(--accent)}
  .switch input:checked + .slider:before{transform:translateX(22px)}

  /* Focus ring */
  :focus-visible{outline:2px solid #6ea8fe66;outline-offset:2px;border-radius:8px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Deutsch Worttrainer — SRS</h1>
    <div class="goal">
      <div class="bar" id="goalBarWrap" role="progressbar" aria-label="Прогресс цели" aria-valuemin="0" aria-valuemax="100">
        <span id="goalBar"></span>
      </div>
      <div id="goalText"><b>0/30</b> сегодня</div>
    </div>
    <div class="tabs" role="tablist" aria-label="Основные разделы">
      <button class="tabbtn active" data-tab="plan" role="tab" aria-selected="true"><span class="ico">
        <svg viewBox="0 0 24 24"><path d="M7 11h10v2H7zM7 7h10v2H7zM5 3h14a2 2 0 0 1 2 2v14l-4-3H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/></svg>
      </span>План</button>
      <button class="tabbtn" data-tab="flash" role="tab" aria-selected="false"><span class="ico">
        <svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zM5 9h14v10H5z"/></svg>
      </span>Флешкарты</button>
      <button class="tabbtn" data-tab="type" role="tab" aria-selected="false"><span class="ico">
        <svg viewBox="0 0 24 24"><path d="M4 6h16v2H4zm3 5h10v2H7zm-3 5h16v2H4z"/></svg>
      </span>Написание</button>
      <button class="tabbtn" data-tab="test" role="tab" aria-selected="false"><span class="ico">
        <svg viewBox="0 0 24 24"><path d="M9 2h6v2H9zM5 6h14v14H5z"/></svg>
      </span>Тест</button>
      <button class="tabbtn" data-tab="artikel" role="tab" aria-selected="false"><span class="ico">
        <svg viewBox="0 0 24 24"><path d="M4 4h16v4H4zM4 10h16v10H4z"/></svg>
      </span>Артикли</button>
      <button class="tabbtn" data-tab="add" role="tab" aria-selected="false"><span class="ico">
        <svg viewBox="0 0 24 24"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>
      </span>Добавить</button>
      <button class="tabbtn" data-tab="stats" role="tab" aria-selected="false"><span class="ico">
        <svg viewBox="0 0 24 24"><path d="M5 9h3v10H5zM10.5 5h3v14h-3zM16 12h3v7h-3z"/></svg>
      </span>Статистика</button>
      <button class="tabbtn" data-tab="learned" role="tab" aria-selected="false"><span class="ico">
        <svg viewBox="0 0 24 24"><path d="M4 6l8-3 8 3v10l-8 3-8-3z"/></svg>
      </span>Выученные</button>
      <button class="tabbtn" data-tab="io" role="tab" aria-selected="false"><span class="ico">
        <svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5zM12 2l5.5 7h-11z"/></svg>
      </span>Импорт/Экспорт</button>
      <button class="tabbtn" data-tab="settings" role="tab" aria-selected="false"><span class="ico">
        <svg viewBox="0 0 24 24"><path d="M19.4 13a7.7 7.7 0 0 0 0-2l2-1.5-2-3.5-2.3.5a7.7 7.7 0 0 0-1.7-1L15 2h-6l-.4 2.5a7.7 7.7 0 0 0-1.7 1L4.6 6 2.6 9.5 4.6 11a7.7 7.7 0 0 0 0 2l-2 1.5 2 3.5 2.3-.5a7.7 7.7 0 0 0 1.7 1L9 22h6l.4-2.5a7.7 7.7 0 0 0 1.7-1l2.3.5 2-3.5zM12 15a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>
      </span>Настройки</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- PLAN -->
  <section id="tab-plan" class="active" role="tabpanel" aria-labelledby="План">
    <div class="card grid cols-2">
      <div>
        <h3>Ежедневный план</h3>
        <p class="hint">
          Цель: <b id="dailyTargetText">30</b> слов/повторов. План формируется из
          <b>просроченных по SRS</b> + <b>новых</b>. Засчитывается, когда вы отвечаете правильно.
          Перетаскивайте слова, помечайте ☆ «сложные» — они будут попадаться чаще.
        </p>
        <div class="row">
          <input type="number" id="targetInput" min="5" max="200" value="30" aria-label="цель на день"/>
          <button class="btn" id="saveTarget">Сохранить цель</button>
          <button class="btn primary" id="planFill">Сформировать план на сегодня</button>
        </div>
        <p class="hint" id="planHint"></p>
        <div id="planList" aria-live="polite"></div>
      </div>
      <div>
        <h3>Быстрое добавление (по одному в строке)</h3>
        <label for="bulk">Формат: <code>der Hund — собака</code> или <code>Haus; дом</code></label>
        <textarea id="bulk" placeholder="der Hund — собака
lernen — учить
Mädchen — девочка"></textarea>
        <div class="row">
          <button class="btn" id="bulkAdd">Добавить строки</button>
          <span class="hint" id="bulkHint"></span>
        </div>
        <p class="hint">Подсказка: импортируйте частотные списки и формируйте план одним кликом.</p>
      </div>
    </div>
  </section>

  <!-- FLASHCARDS -->
  <section id="tab-flash" role="tabpanel" aria-labelledby="Флешкарты">
    <div class="card">
      <div id="fcDeckEmpty" class="hint">Нет слов в плане на сегодня. Откройте вкладку «План» и добавьте слова.</div>
      <div id="fcDeck" style="display:none">
        <div class="row" style="justify-content:space-between">
          <div class="pill">Осталось: <span id="fcLeft">0</span></div>
          <div class="pill">Повтор: <span id="fcMeta">—</span></div>
        </div>
        <div class="fc-word" id="fcWord">…</div>
        <div class="fc-translation" id="fcTrans" hidden>…</div>
        <div class="row" style="justify-content:center;gap:10px;margin:8px 0 16px">
          <button class="btn" id="showTrans">Показать перевод</button>
        </div>
        <div class="row" style="justify-content:center;gap:10px;margin:0 0 16px">
          <button class="btn" id="fcPlay">▶ Произнести</button>
        </div>
        <div class="big-actions">
          <button class="btn bad" id="fcAgain" title="Неправильно (q=1)">Не помню</button>
          <button class="btn" id="fcHard" title="С трудом (q=3)">С трудом</button>
          <button class="btn good" id="fcGood" title="Нормально (q=4)">Знаю</button>
          <button class="btn primary" id="fcEasy" title="Легко (q=5)">Легко</button>
        </div>
      </div>
    </div>
  </section>

  <!-- TYPING -->
  <section id="tab-type" role="tabpanel" aria-labelledby="Написание">
    <div class="card">
      <div id="tyEmpty" class="hint">Нет слов в плане на сегодня.</div>
      <div id="tyWrap" style="display:none">
        <div class="pill">Осталось: <span id="tyLeft">0</span></div>
        <p class="muted">Перевод:</p>
        <div class="fc-translation" id="tyPrompt">…</div>
        <label for="tyInput">Введите слово по-немецки</label>
        <input id="tyInput" autocomplete="off" spellcheck="false"/>
        <div class="row" style="margin-top:8px">
          <span class="hint">Удобные клавиши:</span>
          <button class="btn kbd" data-ins="ä">ä</button>
          <button class="btn kbd" data-ins="ö">ö</button>
          <button class="btn kbd" data-ins="ü">ü</button>
          <button class="btn kbd" data-ins="ß">ß</button>
          <button class="btn" id="tyReveal">Буква</button>
          <button class="btn" id="tyCheck">Проверить</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="tyPlay">▶ Произнести</button>
        </div>
        <p id="tyFeedback" class="hint"></p>
      </div>
    </div>
  </section>

  <!-- TEST (4 варианта) -->
  <section id="tab-test" role="tabpanel" aria-labelledby="Тест">
    <div class="card">
      <div id="tEmpty" class="hint">Нет слов в плане на сегодня.</div>
      <div id="tWrap" style="display:none">
        <div class="pill">Осталось: <span id="tLeft">0</span></div>
        <div class="fc-word" id="tQuestion">…</div>
        <div class="grid" style="gap:8px">
          <button class="btn" data-opt="0"></button>
          <button class="btn" data-opt="1"></button>
          <button class="btn" data-opt="2"></button>
          <button class="btn" data-opt="3"></button>
        </div>
        <p id="tFeedback" class="hint"></p>
      </div>
    </div>
  </section>

  <!-- ARTIKEL TRAINER -->
  <section id="tab-artikel" role="tabpanel" aria-labelledby="Артикли">
    <div class="card">
      <div id="arEmpty" class="hint">Нет подходящих слов (нужны существительные с der/die/das). Добавьте их и сформируйте план.</div>
      <div id="arWrap" style="display:none">
        <div class="pill">Осталось: <span id="arLeft">0</span></div>
        <div class="fc-word" id="arPrompt">…</div>
        <div class="row" style="justify-content:center;gap:8px;margin:8px 0 12px">
          <button class="btn" data-ans="der">der</button>
          <button class="btn" data-ans="die">die</button>
          <button class="btn" data-ans="das">das</button>
        </div>
        <p class="hint" id="arHint">Подсказка по окончаниям: <code>-ung → die</code>, <code>-chen → das</code>, <code>-er → der</code></p>
      </div>
    </div>
  </section>

  <!-- ADD WORDS -->
  <section id="tab-add" role="tabpanel" aria-labelledby="Добавить">
    <div class="card grid cols-2">
      <div>
        <h3>Добавить слово</h3>
        <label>Немецкое слово</label>
        <input id="wDe" placeholder="das Haus"/>
        <label>Перевод</label>
        <input id="wRu" placeholder="дом"/>
        <label>Ссылка на аудио (MP3, опц.)</label>
        <input id="wAudio" placeholder="https://.../word.mp3"/>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="wAdd">Добавить</button>
          <span class="hint" id="wHint"></span>
        </div>
      </div>
      <div>
        <h3>Ваш словарь</h3>
        <div id="dictList" class="hint">Пока пусто</div>
      </div>
    </div>
  </section>

  <!-- STATS -->
  <section id="tab-stats" role="tabpanel" aria-labelledby="Статистика">
    <div class="card">
      <h3>Статистика</h3>
      <div class="grid cols-2">
        <div>
          <p>Серия дней (streak): <b id="streak">0</b></p>
          <p>Сегодня правильно: <b id="todayCorrect">0</b>, ошибок: <b id="todayWrong">0</b></p>
          <p>Всего слов в словаре: <b id="totalWords">0</b></p>
          <p>Сегодня по SRS назначено на повтор: <b id="dueCount">0</b></p>
        </div>
        <div>
          <table>
            <thead>
              <tr><th>Дата</th><th>Засчитано</th><th class="right">Детали</th></tr>
            </thead>
            <tbody id="histBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- LEARNED -->
  <section id="tab-learned" role="tabpanel" aria-labelledby="Выученные">
    <div class="card">
      <h3>Выученные слова</h3>
      <div class="row" style="margin-bottom:8px">
        <label style="margin:0">Дата: <input type="date" id="learnedDate"/></label>
        <button class="btn" id="learnedToday">Сегодня</button>
      </div>
      <div id="learnedList" class="hint">Пока нет данных</div>
    </div>
  </section>

  <!-- IO -->
  <section id="tab-io" role="tabpanel" aria-labelledby="Импорт/Экспорт">
    <div class="card grid cols-2">
      <div>
        <h3>Экспорт</h3>
        <p class="hint">Скачайте JSON со словарём, SRS и статистикой.</p>
        <button class="btn" id="exportBtn">Экспортировать JSON</button>
      </div>
      <div>
        <h3>Импорт</h3>
        <input type="file" id="importFile" accept="application/json"/>
        <button class="btn" id="importBtn">Импортировать</button>
        <label class="row" style="margin-top:8px">
          <input type="checkbox" id="importReplace"/> Полностью заменить (очистить старые данные)
        </label>
        <p class="hint" id="importHint"></p>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="tab-settings" role="tabpanel" aria-labelledby="Настройки">
    <div class="card grid cols-2">
      <div>
        <h3>Внешний вид</h3>
        <div class="row">
          <label>Тёмная тема</label>
          <label class="switch"><input id="swDark" type="checkbox" checked/><span class="slider"></span></label>
        </div>
        <p class="hint">Тема сохраняется в браузере. Приложение офлайн, данные — только у вас.</p>
      </div>
      <div>
        <h3>Резерв</h3>
        <button class="btn bad" id="btnWipe">Полный сброс (осторожно)</button>
        <p class="hint">Очистит словарь, статистику, цель и прогресс.</p>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ================== STORAGE ================== */
const LS = {
  load(key, fallback){ try{const v = JSON.parse(localStorage.getItem(key)); return v ?? fallback;}catch(_){return fallback}},
  save(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
};
const K = { words:"dw_words", stats:"dw_stats", plan:"dw_today_plan", donePrefix:"dw_done_", target:"dw_target", theme:"dw_theme" };

/* Local date string (no UTC shift) */
function todayStr(){
  const d = new Date(); const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`;
}

/* Words CRUD */
function getWords(){ return (LS.load(K.words, [])||[]).map(migrateWord) }
function setWords(w){ LS.save(K.words, w) }
function getStats(){ return LS.load(K.stats, {}) }
function setStats(s){ LS.save(K.stats, s) }
function getTarget(){ return +LS.load(K.target, 30) }
function setTarget(n){ LS.save(K.target, Math.max(5, Math.min(200, +n || 30))) }
function getPlan(){
  const p = LS.load(K.plan, {date: todayStr(), ids: []});
  if(p.date !== todayStr()) return {date: todayStr(), ids: []};
  return p;
}
function setPlan(p){ LS.save(K.plan, p) }
function getDone(date=todayStr()){ return new Set(LS.load(K.donePrefix+date, [])) }
function addDone(id, date=todayStr()){
  const s = getDone(date); s.add(id); LS.save(K.donePrefix+date, Array.from(s))
}

/* ============== SRS (SM-2 lite) ============== */
/* Migration: add srs if missing (NO data loss) */
function migrateWord(w){
  if(!w.srs){
    w.srs = { ease: 2.5, reps: 0, lapses: 0, interval: 0, due: todayStr(), stage: 0, hard: false };
  }else{
    // ensure fields
    w.srs.ease = Math.max(1.3, +w.srs.ease || 2.5);
    w.srs.reps = +w.srs.reps || 0;
    w.srs.lapses = +w.srs.lapses || 0;
    w.srs.interval = +w.srs.interval || 0;
    w.srs.due = w.srs.due || todayStr();
    if(typeof w.srs.stage!=='number') w.srs.stage = w.srs.reps;
    if(typeof w.srs.hard!=='boolean') w.srs.hard = false;
  }
  return w;
}
function srsIsDue(w, date=todayStr()){ return (w.srs?.due||todayStr()) <= date }
function srsGrade(w, q){
  // q: 1=again, 3=hard, 4=good, 5=easy
  const s = w.srs;
  if(q <= 2){
    s.lapses += 1;
    s.reps = 0;
    s.interval = 1;
    s.ease = Math.max(1.3, s.ease - 0.2);
    s.due = plusDays(1);
  }else{
    if(s.reps === 0) s.interval = 1;
    else if(s.reps === 1) s.interval = 3;
    else s.interval = Math.round(s.interval * s.ease * (q===5?1.2:(q===3?0.85:1)));
    s.ease = Math.max(1.3, s.ease + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02)));
    s.reps += 1;
    s.stage = Math.max(s.stage||0, s.reps);
    s.due = plusDays(s.interval);
  }
}
function plusDays(n){
  const d = new Date(); d.setDate(d.getDate() + (n||0));
  const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

/* ================== UI HELPERS ================== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function toast(msg){
  const el = $("#toast"); el.textContent = msg; el.style.opacity = 1; clearTimeout(el._t);
  el._t = setTimeout(()=>{el.style.opacity = 0}, 2200);
}
function updateGoal(){
  const target = getTarget(); const done = getDone();
  $("#goalText").innerHTML = `<b>${done.size}/${target}</b> сегодня`;
  const pct = Math.min(100, Math.round(done.size/target*100));
  $("#goalBar").style.width = pct + "%";
  $("#goalBarWrap").setAttribute("aria-valuenow", String(pct));
  $("#dailyTargetText").textContent = target;
}

/* ================== DICT/DELETE ================== */
function makeId(de){
  return de.trim().toLowerCase().replace(/^(der|die|das)\s+/,'').replace(/\s+/g,' ');
}
function rebuildDictList(){
  const words = getWords();
  const wrap = $("#dictList");
  const box = document.createElement("div");
  if(words.length===0){ box.className="hint"; box.textContent="Пока пусто"; }
  else {
    words.slice().reverse().forEach(w=>{
      const row = document.createElement("div");
      row.style.margin="6px 0";
      const star = `<span class="star ${w.srs?.hard?'active':''}" data-star="${w.id}" title="Пометить как сложное (чаще попадётся)">☆</span>`;
      row.innerHTML = `<span class="chip">${star} ${w.de}</span> <span class="muted">— ${w.ru}</span>
      <span class="muted">· due: ${w.srs?.due}</span>
      <button class="btn bad" data-del="${w.id}">Удалить</button>`;
      box.appendChild(row);
    });
  }
  wrap.innerHTML = ""; wrap.appendChild(box);
  $("#totalWords").textContent = words.length;
}
$("#dictList").addEventListener("click",(e)=>{
  const star = e.target.closest("[data-star]");
  if(star){
    const id = star.getAttribute("data-star");
    const words = getWords(); const w = words.find(x=>x.id===id); if(!w) return;
    w.srs.hard = !w.srs.hard; setWords(words); rebuildDictList(); return;
  }
  const btn = e.target.closest("button[data-del]"); if(!btn) return;
  const id = btn.dataset.del;
  if(!confirm("Точно удалить это слово из словаря и прогресса?")) return;
  // remove word
  const words = getWords().filter(w=>w.id!==id); setWords(words);
  // remove from plan
  const p = getPlan(); p.ids = p.ids.filter(x=>x!==id); setPlan(p);
  // clean from all done-sets
  const toClean = []; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k && k.startsWith(K.donePrefix)) toClean.push(k) }
  toClean.forEach(k=>{ const set = new Set(LS.load(k,[])); if(set.delete(id)) LS.save(k, Array.from(set)) });
  rebuildDictList(); renderPlan(); setupDecks(); updateGoal(); renderStats();
});

/* ================== PLAN (with SRS) ================== */
function renderPlan(){
  const plan = getPlan(); const words = getWords();
  const list = plan.ids.map(id => words.find(w=>w.id===id)).filter(Boolean);
  $("#planHint").textContent = plan.ids.length ? `В плане на ${plan.date}: ${plan.ids.length} слов(а)` : "Сегодняшний план пуст.";
  const wrap = $("#planList"); wrap.innerHTML = "";
  const box = document.createElement("div");
  list.forEach(w=>{
    const row = document.createElement("div");
    row.className="row drag"; row.setAttribute("draggable","true"); row.dataset.id=w.id;
    const star = `<span class="star ${w.srs?.hard?'active':''}" data-star="${w.id}" title="Пометить как сложное">☆</span>`;
    row.innerHTML = `<span class="chip">${star} ${w.de}</span> <span class="muted">— ${w.ru}</span>
    <span class="pill">SRS: rep ${w.srs.reps} · due ${w.srs.due}</span>`;
    box.appendChild(row);
  });
  wrap.appendChild(box);
  enableDrag(box);
}
function enableDrag(container){
  let dragEl=null;
  container.addEventListener("dragstart",(e)=>{ dragEl = e.target.closest(".drag"); if(dragEl) e.dataTransfer.setData("text/plain", dragEl.dataset.id) });
  container.addEventListener("dragover",(e)=>{ e.preventDefault(); const t = e.target.closest(".drag"); if(!dragEl||!t||t===dragEl) return;
    const box = container; const rect = t.getBoundingClientRect(); const before = (e.clientY - rect.top) < rect.height/2;
    box.insertBefore(dragEl, before? t : t.nextSibling);
  });
  container.addEventListener("drop",()=> {
    const ids = Array.from(container.querySelectorAll(".drag")).map(x=>x.dataset.id);
    const p = getPlan(); p.ids = ids; setPlan(p);
  });
}
function fillPlan(){
  const target = getTarget(); const words = getWords(); const done = getDone();
  const today = todayStr();

  // 1) Due words first (SRS): sort by due asc, then hard priority
  const due = words.filter(w => !done.has(w.id) && srsIsDue(w, today))
                   .sort((a,b)=> (a.srs.due>b.srs.due?1:-1) || ((b.srs.hard?1:0)-(a.srs.hard?1:0)));

  // 2) Then NEW words (reps==0), prefer "hard"
  const fresh = words.filter(w => !done.has(w.id) && w.srs.reps===0)
                     .sort((a,b)=> (b.srs.hard?1:0) - (a.srs.hard?1:0));

  // 3) Then the rest (not due but for extra practice if room)
  const rest = words.filter(w => !done.has(w.id) && w.srs.reps>0 && !srsIsDue(w, today))
                    .sort((a,b)=> (a.srs.due>b.srs.due?1:-1));

  const ordered = [...due, ...fresh, ...rest];
  const ids = ordered.slice(0, target).map(w=>w.id);

  setPlan({ date: today, ids }); renderPlan(); setupDecks(); updateGoal();
  $("#dueCount").textContent = due.length;
}

/* ================== FLASHCARDS ================== */
let fcQueue=[], fcCurrent=null;
function setupFlash(){
  const plan = getPlan(); const done = getDone(); const words = getWords().filter(w=> plan.ids.includes(w.id) && !done.has(w.id));
  fcQueue = weightedShuffle(words); fcCurrent=null;
  $("#fcDeckEmpty").style.display = words.length? "none":"block";
  $("#fcDeck").style.display = words.length? "block":"none";
  $("#fcLeft").textContent = words.length; $("#fcTrans").hidden = true; $("#showTrans").disabled = false;
  if(words.length) nextFC();
}
function weightedShuffle(arr){
  // boost hard and due items
  const today = todayStr();
  const pool = [];
  arr.forEach(w=>{
    const weight = (w.srs.hard?2:1) + (srsIsDue(w,today)?2:0);
    for(let i=0;i<weight;i++) pool.push(w);
  });
  return shuffle(pool).filter((v,i,self)=> self.indexOf(v)===i); // unique keep order by first appearance
}
function nextFC(){
  fcCurrent = fcQueue.shift();
  if(!fcCurrent){ setupFlash(); return; }
  $("#fcWord").textContent = fcCurrent.de;
  $("#fcTrans").textContent = fcCurrent.ru;
  $("#fcTrans").hidden = true; $("#fcMeta").textContent = `rep ${fcCurrent.srs.reps} · due ${fcCurrent.srs.due}`;
}
$("#showTrans").addEventListener("click",()=>{ $("#fcTrans").hidden = false; $("#showTrans").disabled = true; });
$("#fcPlay").addEventListener("click",()=> playFor(fcCurrent));
$("#fcAgain").addEventListener("click",()=> fcAnswer(1));
$("#fcHard").addEventListener("click",()=> fcAnswer(3));
$("#fcGood").addEventListener("click",()=> fcAnswer(4));
$("#fcEasy").addEventListener("click",()=> fcAnswer(5));
function fcAnswer(q){
  if(!fcCurrent) return;
  srsGrade(fcCurrent, q);
  const words = getWords(); const idx = words.findIndex(w=>w.id===fcCurrent.id);
  if(idx>=0){ words[idx] = fcCurrent; setWords(words) }
  if(q>=3){ addDone(fcCurrent.id); bumpStat(q===3 ? "hard" : "correct"); $("#fcLeft").textContent = +$("#fcLeft").textContent - 1; updateGoal(); }
  else { bumpStat("wrong"); }
  nextFC();
}

/* ================== TYPING ================== */
let tyQueue=[], tyCurrent=null, tyRevealIdx=0;
function setupTyping(){
  const plan=getPlan(); const done=getDone(); const words=getWords().filter(w=> plan.ids.includes(w.id) && !done.has(w.id));
  tyQueue = weightedShuffle(words); tyCurrent=null;
  $("#tyEmpty").style.display = words.length? "none":"block";
  $("#tyWrap").style.display = words.length? "block":"none";
  $("#tyLeft").textContent = words.length; if(words.length) nextTy();
}
function nextTy(){
  tyCurrent = tyQueue.shift(); tyRevealIdx = 0;
  if(!tyCurrent){ setupTyping(); return; }
  $("#tyPrompt").textContent = tyCurrent.ru; $("#tyInput").value=""; $("#tyFeedback").textContent=""; $("#tyInput").focus();
}
function norm(s){ return s.trim().toLowerCase().replace(/[\s\-.]+/g,' ') }
function equalDe(a,b){
  const m={ä:"ae",ö:"oe",ü:"ue",ß:"ss"}; const x=s=>norm(s).replace(/[äöüß]/g,ch=>m[ch]||ch);
  return x(a)===x(b);
}
function checkTyping(){
  if(!tyCurrent) return;
  const user = $("#tyInput").value;
  if(equalDe(user, tyCurrent.de)){
    $("#tyFeedback").innerHTML = `✅ Верно: <b>${tyCurrent.de}</b>`;
    srsGrade(tyCurrent, 4); // good
    persistWord(tyCurrent);
    addDone(tyCurrent.id); bumpStat("typedCorrect");
    $("#tyLeft").textContent = +$("#tyLeft").textContent - 1; updateGoal();
    setTimeout(nextTy, 450);
  } else {
    $("#tyFeedback").innerHTML = `❌ Неверно. Правильно: <b>${tyCurrent.de}</b>`;
    srsGrade(tyCurrent, 1); persistWord(tyCurrent); bumpStat("wrong");
    setTimeout(nextTy, 900);
  }
}
function persistWord(w){
  const words=getWords(); const i=words.findIndex(x=>x.id===w.id); if(i>=0){ words[i]=w; setWords(words) }
}
$("#tyCheck").addEventListener("click", checkTyping);
$("#tyInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); checkTyping(); }});
$(".row .btn.kbd")?.addEventListener?.("click",()=>{}); // placeholder
$$(".kbd").forEach(b=> b.addEventListener("click",()=>{
  const ins = b.dataset.ins; const i=$("#tyInput"); const start=i.selectionStart, end=i.selectionEnd;
  const v=i.value; i.value = v.slice(0,start)+ins+v.slice(end); i.focus(); i.selectionStart = i.selectionEnd = start + ins.length;
}));
$("#tyReveal").addEventListener("click", ()=>{
  if(!tyCurrent) return;
  const ans = tyCurrent.de;
  tyRevealIdx = Math.min(ans.length, tyRevealIdx+1);
  $("#tyInput").value = ans.slice(0,tyRevealIdx);
});
$("#tyPlay").addEventListener("click",()=> playFor(tyCurrent));

/* ================== TEST (MCQ) ================== */
let tQueue=[], tCurrent=null, tOpts=[];
function setupTest(){
  const plan=getPlan(); const done=getDone(); const pool=getWords().filter(w=> plan.ids.includes(w.id) && !done.has(w.id));
  tQueue = weightedShuffle(pool); tCurrent=null;
  $("#tEmpty").style.display = pool.length? "none":"block";
  $("#tWrap").style.display = pool.length? "block":"none";
  $("#tLeft").textContent = pool.length; if(pool.length) nextT();
}
function nextT(){
  tCurrent = tQueue.shift(); if(!tCurrent){ setupTest(); return; }
  $("#tQuestion").textContent = tCurrent.de;
  const words = getWords(); const distractors = shuffle(words.filter(w=>w.id!==tCurrent.id)).slice(0,3).map(w=>w.ru);
  tOpts = shuffle([tCurrent.ru, ...distractors]);
  $$("#tab-test [data-opt]").forEach((btn,i)=>{ btn.textContent = tOpts[i]; btn.disabled=false; btn.classList.remove("good","bad") });
  $("#tFeedback").textContent = "";
}
$("#tab-test").addEventListener("click",(e)=>{
  const btn = e.target.closest("[data-opt]"); if(!btn||!tCurrent) return;
  const picked = btn.textContent;
  if(picked === tCurrent.ru){
    btn.classList.add("good"); $("#tFeedback").textContent = "✅ Верно";
    srsGrade(tCurrent,4); persistWord(tCurrent); addDone(tCurrent.id); bumpStat("correct");
    $("#tLeft").textContent = +$("#tLeft").textContent - 1; updateGoal();
    setTimeout(nextT, 500);
  } else {
    btn.classList.add("bad"); $("#tFeedback").textContent = `❌ Неверно. Ответ: ${tCurrent.ru}`;
    srsGrade(tCurrent,1); persistWord(tCurrent); bumpStat("wrong");
    setTimeout(nextT, 900);
  }
});

/* ================== AUDIO ================== */
const player = new Audio();
function playFor(w){
  if(!w) return;
  if(w.audio){
    try{ player.src = w.audio; player.play(); return; }catch(_){}
  }
  if("speechSynthesis" in window){
    const u = new SpeechSynthesisUtterance(w.de);
    const v = speechSynthesis.getVoices().find(v=>/de(-|_|$)/i.test(v.lang)) || null;
    if(v) u.voice = v; u.lang = "de-DE"; speechSynthesis.speak(u);
  }
}
if('speechSynthesis' in window){
  // ensure voices loaded
  speechSynthesis.onvoiceschanged = ()=> speechSynthesis.getVoices();
}

/* ================== ARTIKEL ================== */
let arQueue=[], arCurrent=null;
function setupArtikel(){
  const plan=getPlan(); const done=getDone();
  const words=getWords().filter(w=> plan.ids.includes(w.id) && !done.has(w.id));
  const nouns = words.filter(w=> /^(der|die|das)\s+/i.test(w.de));
  arQueue = weightedShuffle(nouns); arCurrent=null;
  $("#arEmpty").style.display = nouns.length? "none":"block";
  $("#arWrap").style.display = nouns.length? "block":"none";
  $("#arLeft").textContent = nouns.length; if(nouns.length) nextAr();
}
function nextAr(){
  arCurrent = arQueue.shift();
  if(!arCurrent){ setupArtikel(); return; }
  $("#arPrompt").textContent = arCurrent.de.replace(/^\w+\s+/, "_____ ");
}
$("#tab-artikel").addEventListener("click",(e)=>{
  const b = e.target.closest("button[data-ans]"); if(!b||!arCurrent) return;
  const ans = b.dataset.ans; const correct = new RegExp("^"+ans+"\\s","i").test(arCurrent.de);
  if(correct){
    addDone(arCurrent.id); bumpStat("correct");
    srsGrade(arCurrent,4); persistWord(arCurrent);
    $("#arLeft").textContent = +$("#arLeft").textContent - 1; updateGoal(); nextAr();
  } else {
    srsGrade(arCurrent,1); persistWord(arCurrent); bumpStat("wrong");
    b.classList.add("bad"); setTimeout(()=> b.classList.remove("bad"), 300);
  }
});

/* ================== LEARNED ================== */
function addToPlanToday(id){
  const p=getPlan(); if(!p.ids.includes(id)){ p.ids.push(id); setPlan(p) }
}
function deleteWordById(id){
  const words=getWords().filter(w=>w.id!==id); setWords(words);
  const p=getPlan(); p.ids = p.ids.filter(x=>x!==id); setPlan(p);
  const keys=[]; for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i); if(k && k.startsWith(K.donePrefix)) keys.push(k)}
  keys.forEach(k=>{ const set=new Set(LS.load(k,[])); if(set.delete(id)) LS.save(k, Array.from(set)) });
}
function listLearned(date){
  const ids = Array.from(getDone(date)); const words=getWords();
  const box=document.createElement("div");
  if(!ids.length){ box.className="hint"; box.textContent="Пока нет данных"; }
  ids.forEach(id=>{
    const w = words.find(x=>x.id===id); if(!w) return;
    const row=document.createElement("div"); row.style.margin="6px 0";
    row.innerHTML = `<span class="chip">${w.de}</span> <span class="muted">— ${w.ru}</span>
    <button class="btn" data-act="play" data-id="${w.id}">▶</button>
    <button class="btn" data-act="return" data-id="${w.id}">↩ вернуть</button>
    <button class="btn" data-act="delete" data-id="${w.id}">🗑 удалить</button>`;
    box.appendChild(row);
  });
  const wrap=$("#learnedList"); wrap.innerHTML=""; wrap.appendChild(box);
}
$("#learnedToday").addEventListener("click",()=>{ $("#learnedDate").value=todayStr(); listLearned(todayStr()) });
$("#learnedDate").addEventListener("change",(e)=> listLearned(e.target.value));
$("#tab-learned").addEventListener("click",(e)=>{
  const btn=e.target.closest("button[data-act]"); if(!btn) return;
  const id=btn.dataset.id; const date=$("#learnedDate").value || todayStr(); const w=getWords().find(x=>x.id===id);
  if(btn.dataset.act==="play" && w) playFor(w);
  if(btn.dataset.act==="return"){
    const set=getDone(date); set.delete(id); LS.save(K.donePrefix+date, Array.from(set));
    addToPlanToday(id); updateGoal(); listLearned(date); setupDecks(); renderPlan();
  }
  if(btn.dataset.act==="delete"){
    deleteWordById(id); updateGoal(); listLearned(date); rebuildDictList(); renderPlan(); setupDecks();
  }
});

/* ================== ADD / BULK ================== */
function addWord(de, ru){
  de = de.trim(); ru = ru.trim(); if(!de||!ru) return false;
  const words = getWords(); const id = makeId(de);
  if(words.some(w=>w.id===id)) return false;
  const audio = ($("#wAudio")?.value || "").trim();
  const obj = { id, de, ru, createdAt: Date.now() };
  if(audio) obj.audio = audio;
  obj.srs = { ease:2.5, reps:0, lapses:0, interval:0, due: todayStr(), stage:0, hard:false };
  words.push(obj); setWords(words);
  rebuildDictList(); renderPlan(); setupDecks(); return true;
}
$("#wAdd").addEventListener("click", ()=>{
  const ok = addWord($("#wDe").value, $("#wRu").value);
  toast(ok? "Добавлено!" : "Проверьте поля (возможно, дубль)");
  if(ok){ $("#wDe").value=""; $("#wRu").value=""; $("#wAudio").value="" }
});
$("#bulkAdd").addEventListener("click", ()=>{
  const lines = $("#bulk").value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  let n=0, skipped=0;
  lines.forEach(line=>{
    const m = line.split(/\s*[—:-;]\s*|\s*;\s*/);
    if(m.length>=2){ if(addWord(m[0], m.slice(1).join(" – "))) n++; else skipped++; }
    else skipped++;
  });
  toast(n ? `Добавлено: ${n}${skipped?`, пропущено: ${skipped}`:''}` : "Ничего не распознано");
  if(n) $("#bulk").value="";
});

/* ================== IMPORT / EXPORT ================== */
function wipeAll(){
  localStorage.removeItem(K.words);
  localStorage.removeItem(K.stats);
  localStorage.removeItem(K.target);
  localStorage.removeItem(K.plan);
  const toDel=[]; for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i); if(k && k.startsWith(K.donePrefix)) toDel.push(k)}
  toDel.forEach(k=> localStorage.removeItem(k));
}
$("#exportBtn").addEventListener("click", ()=>{
  const data = { words:getWords(), stats:getStats(), target:getTarget() };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "worttrainer_backup.json"; a.click();
});
$("#importBtn").addEventListener("click", ()=>{
  const f = $("#importFile").files[0]; if(!f){ toast("Выберите файл"); return; }
  const replaceAll = $("#importReplace")?.checked;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const data = JSON.parse(reader.result);
      if(replaceAll) wipeAll();
      const words = Array.isArray(data.words) ? data.words.map(migrateWord).filter(w=>w && typeof w.de==="string" && typeof w.ru==="string") : [];
      setWords(words);
      if(data.stats && typeof data.stats==="object") setStats(data.stats); else setStats({});
      if(typeof data.target==="number") setTarget(+data.target); else setTarget(30);

      // авто-план на сегодня
      const target=getTarget(); const ids = words.map(w=>w.id).slice(0,target);
      setPlan({date: todayStr(), ids});

      rebuildDictList(); renderPlan(); setupDecks(); renderStats(); updateGoal();
      toast("Импортировано и сформирован план на сегодня");
    }catch(e){ console.error(e); toast("Ошибка импорта: неверный JSON") }
  };
  reader.readAsText(f);
});

/* ================== TABS & STATS ================== */
$$(".tabbtn").forEach(b=> b.addEventListener("click", ()=>{
  $$(".tabbtn").forEach(x=>{ x.classList.remove("active"); x.setAttribute("aria-selected","false") });
  b.classList.add("active"); b.setAttribute("aria-selected","true");
  const id = b.dataset.tab; $$("main section").forEach(s=> s.classList.remove("active"));
  $("#tab-"+id).classList.add("active");
  if(id==="flash") setupFlash();
  if(id==="type") setupTyping();
  if(id==="test") setupTest();
  if(id==="stats") renderStats();
  if(id==="artikel") setupArtikel();
  if(id==="learned"){ $("#learnedDate").value = todayStr(); listLearned(todayStr()) }
}));

function bumpStat(kind){
  const d=todayStr(); const s=getStats();
  s[d] = s[d] || { learned:0, correct:0, wrong:0, typedCorrect:0, hard:0 };
  if(kind==="correct") s[d].correct++;
  if(kind==="wrong") s[d].wrong++;
  if(kind==="typedCorrect"){ s[d].typedCorrect++; s[d].correct++; }
  if(kind==="hard") s[d].hard++;
  s[d].learned = getDone(d).size;
  setStats(s); renderStats();
}
function renderStats(){
  const s=getStats(); const d=todayStr();
  $("#todayCorrect").textContent = s[d]?.correct || 0;
  $("#todayWrong").textContent = s[d]?.wrong || 0;
  const keys = Object.keys(s).filter(k=>/\d{4}-\d{2}-\d{2}/.test(k)).sort().slice(-14);
  const tbody=document.createElement("tbody"); keys.reverse().forEach(k=>{
    const rec=s[k];
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${k}</td><td>${rec.learned||0}</td><td class="right muted">верн.: ${rec.correct||0} / ошиб.: ${rec.wrong||0}</td>`;
    tbody.appendChild(tr);
  });
  $("#histBody").replaceWith(tbody); tbody.id="histBody";
  $("#streak").textContent = calcStreak();

  // due count today
  const words=getWords(); const due = words.filter(w=> srsIsDue(w, todayStr()) ).length;
  $("#dueCount").textContent = due;
}
function calcStreak(){
  const s=getStats(); const target=getTarget(); let streak=0; const date=new Date();
  for(let i=0;i<365;i++){
    const ds = date.toISOString().slice(0,10); // здесь для streak допустим UTC — статистика не критична
    if(s[ds]?.learned >= target){ streak++; date.setDate(date.getDate()-1) } else break;
  }
  return streak;
}
function shuffle(a){
  const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]] } return x;
}

/* ================== SETTINGS ================== */
function applyTheme(){
  const th = LS.load(K.theme, "dark"); const root = document.documentElement;
  if(th==="dark"){ root.style.setProperty('--bg','#0f1220'); $("#swDark").checked = true; }
  else { root.style.setProperty('--bg','#f7f8ff'); /* простой переключатель; остальная палитра остаётся тёмной для контраста */ $("#swDark").checked = false; }
}
$("#swDark").addEventListener("change",(e)=>{ LS.save(K.theme, e.target.checked? "dark":"light"); applyTheme(); });
$("#btnWipe").addEventListener("click", ()=>{ if(confirm("Точно полностью очистить данные?")){ wipeAll(); location.reload() }});

/* ================== INIT ================== */
function setupDecks(){ setupFlash(); setupTyping(); setupTest(); }
function init(){
  const p=getPlan(); if(p.date !== todayStr()) setPlan({date: todayStr(), ids: []});
  $("#targetInput").value = getTarget();
  $("#saveTarget").addEventListener("click", ()=>{ setTarget($("#targetInput").value); updateGoal(); renderStats(); toast("Цель сохранена") });
  $("#planFill").addEventListener("click", fillPlan);
  rebuildDictList(); renderPlan(); setupDecks(); renderStats(); updateGoal();
  if('speechSynthesis' in window){ speechSynthesis.getVoices() }
  applyTheme();
  // Keyboard shortcuts in flashcards
  document.addEventListener("keydown",(e)=>{
    if(!$("#tab-flash").classList.contains("active")) return;
    if(e.key===" "){ e.preventDefault(); $("#showTrans").click() }
    if(e.key==="ArrowLeft"){ e.preventDefault(); $("#fcAgain").click() }
    if(e.key==="ArrowDown"){ e.preventDefault(); $("#fcHard").click() }
    if(e.key==="ArrowRight" || e.key==="Enter"){ e.preventDefault(); $("#fcGood").click() }
    if(e.key==="1"){ $("#fcAgain").click() }
    if(e.key==="2"){ $("#fcHard").click() }
    if(e.key==="3"){ $("#fcGood").click() }
    if(e.key==="4"){ $("#fcEasy").click() }
  });
}
init();
</script>
</body>
</html>
